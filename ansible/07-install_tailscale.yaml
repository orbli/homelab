---
- name: Install Tailscale
  hosts: shared_drive
  become: true
  tasks:
    - name: Add Tailscale GPG key
      ansible.builtin.shell: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
      args:
        creates: /usr/share/keyrings/tailscale-archive-keyring.gpg

    - name: Add Tailscale repository
      ansible.builtin.shell: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list
      args:
        creates: /etc/apt/sources.list.d/tailscale.list

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes

    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale
        state: present

    - name: Start and enable Tailscale service
      ansible.builtin.systemd:
        name: tailscaled
        state: started
        enabled: yes

    - name: Connect to Tailscale network with SSH enabled
      ansible.builtin.shell: |
        tailscale up --ssh --accept-dns=false > /tmp/tailscale_output 2>&1 & echo $! > /tmp/tailscale.pid
        sleep 2
        cat /tmp/tailscale_output
      register: tailscale_result
      changed_when: true

    - name: Display Tailscale output
      ansible.builtin.debug:
        msg: "{{ tailscale_result.stdout_lines | map('replace', '\t', '') | list }}"

    - name: Wait for Tailscale up to complete
      ansible.builtin.shell: |
        if [ -f /tmp/tailscale.pid ]; then
          pid=$(cat /tmp/tailscale.pid)
          while kill -0 $pid 2>/dev/null; do
            sleep 5
          done
          rm -f /tmp/tailscale.pid /tmp/tailscale_output
        fi
      changed_when: false

- name: Install Tailscale Operator in Kubernetes
  hosts: localhost
  connection: local
  vars:
    tailscale_oauth_client_id: "{{ hostvars['sd1']['tailscale_oauth_client_id'] }}"
    tailscale_oauth_client_secret: "{{ hostvars['sd1']['tailscale_oauth_client_secret'] }}"
    tailscale_operator_hostname: "{{ hostvars['sd1']['tailscale_operator_hostname'] }}"
  tasks:
    - name: Add Tailscale Helm repository
      kubernetes.core.helm_repository:
        name: tailscale
        repo_url: https://pkgs.tailscale.com/helmcharts

    - name: Install Tailscale Operator
      kubernetes.core.helm:
        name: tailscale-operator
        chart_ref: tailscale/tailscale-operator
        release_namespace: tailscale
        create_namespace: true
        wait: true
        values:
          oauth:
            clientId: "{{ tailscale_oauth_client_id }}"
            clientSecret: "{{ tailscale_oauth_client_secret }}"
          operatorConfig:
            hostname: "{{ tailscale_operator_hostname }}"

    - name: Apply Tailscale Connector configuration
      kubernetes.core.k8s:
        state: present
        src: k8s_configs/ts-connector.yaml

